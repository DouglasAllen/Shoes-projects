<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Rakefile</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            Rakefile
        </h1>
        <ul class="files">
            <li>Rakefile</li>
            <li>Last modified: 2013-04-23 09:29:51 -0500</li>
        </ul>
    </div>

    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>$:.unshift ‘.’</p>

<p>require ‘rubygems’ require ‘rake’ require ‘rake/clean’ if RUBY_VERSION !=
‘1.8.7’ require_relative ‘platform/skel’ else require
File.join(File.dirname(__FILE__), ‘platform/skel’) end require ‘fileutils’
require ‘find’ require ‘yaml’ include FileUtils</p>

<p># Use Syck for backward compatibility YAML::ENGINE.yamler = ‘syck’</p>

<p>APP = <a href="http://'APP'">YAML.load_file(File.join(ENV</a> || “.”,
“app.yaml”)) APPNAME = <a href="http://'name'">APP</a> RELEASE_ID,
RELEASE_NAME = <a href="http://'version'">APP</a>, <a
href="http://'release'">APP</a> NAME = <a href="http://'shortname'">APP</a>
|| <a href="http://'name'">APP</a>.downcase.gsub(/W+/, ”) SONAME = ‘shoes’</p>

<p># Like puts, but only if we’ve –trace’d def vputs(str)</p>

<pre>puts str if Rake.application.options.trace</pre>

<p>end</p>

<p>begin require ‘cucumber’ require ‘cucumber/rake/task’</p>

<p>Cucumber::Rake::Task.new(:features) do |t|</p>

<pre>t.cucumber_opts = &quot;--format pretty&quot;</pre>

<p>end</p>

<p>rescue LoadError</p>

<pre>vputs(&quot;Cukes is not loaded -- please `bundle install`&quot;)</pre>

<p>end</p>

<p>begin</p>

<p>require ‘rspec/core/rake_task’ RSpec::Core::RakeTask.new(:spec) do |t|</p>

<pre>t.rspec_opts = [&quot;--color&quot;]</pre>

<p>end</p>

<p>rescue LoadError</p>

<pre>vputs(&quot;RSpec is not loaded -- please `bundle install`&quot;)</pre>

<p>end</p>

<p>begin</p>

<p>require ‘bundler’ Bundler::GemHelper.install_tasks</p>

<p>rescue LoadError</p>

<pre>vputs(&quot;Bundler is not loaded -- please `gem install bundler &amp;&amp; bundle install`&quot;)</pre>

<p>end</p>

<p>GIT = <a href="http://'GIT'">ENV</a> || “git” REVISION = (`#{GIT} rev-list
HEAD`.split.length + 1).to_s VERS = <a href="http://'VERSION'">ENV</a> ||
“0.r#{REVISION}” PKG = “#{NAME}-#{VERS}” APPARGS = <a
href="http://'run'">APP</a> FLAGS = %w[DEBUG VIDEO] VLC_VERSION =
(RUBY_PLATFORM =~ /win32/ ? “0.8”: `vlc –version <a
href="http://2">2>/dev/null`.split</a>) VLC_0_8 = VLC_VERSION !~ /^0.9/</p>

<p>BIN = “*.{bundle,jar,o,so,obj,pdb,pch,res,lib,def,exp,exe,ilk}”
CLEAN.include [“{bin,shoes}/#{BIN}”, “req   /#{BIN}”, “dist/   *”, “dist”,
“*.app”]</p>

<p>RUBY_SO = <a href="http://'RUBY_SO_NAME'">RbConfig::CONFIG</a> RUBY_V = <a
href="http://'ruby_version'">RbConfig::CONFIG</a> RUBY_LIB_BASE = <a
href="http://'libdir'">File.basename(RbConfig::CONFIG</a>)
RUBY_PROGRAM_VERSION = <a
href="http://'RUBY_PROGRAM_VERSION'">RbConfig::CONFIG</a> SHOES_RUBY_ARCH =
<a href="http://'arch'">RbConfig::CONFIG</a> RUBY_1_9 = (RUBY_V =~ /^1.9/)
if RUBY_1_9</p>

<pre>$: &lt;&lt; &quot;.&quot;</pre>

<p>end</p>

<p>if <a href="http://'APP'">ENV</a></p>

<pre class="ruby"><span class="ruby-node">%w[dmg icons]</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">subk</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">APP</span>[<span class="ruby-identifier">subk</span>].<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">APP</span>[<span class="ruby-identifier">subk</span>][<span class="ruby-identifier">name</span>] = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-string">'APP'</span>], <span class="ruby-constant">APP</span>[<span class="ruby-identifier">subk</span>][<span class="ruby-identifier">name</span>])
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>

<p>if File.exists? “.git/refs/tags/#{RELEASE_ID}/#{RELEASE_NAME}”</p>

<pre>abort &quot;** Rename this release (and add to lib/shoes.rb) #{RELEASE_NAME} has already been tagged.&quot;</pre>

<p>end</p>

<p># Same effect as sourcing a shell script before running rake. It’s
necessary to # set these values before the make/{platform}/env.rb files are
loaded. def osx_bootstrap_env</p>

<pre>ENV['DYLD_LIBRARY_PATH'] = '/usr/local/Cellar/cairo/1.10.2/lib:/usr/local/Cellar/cairo/1.10.2/include/cairo'
ENV['LD_LIBRARY_PATH'] = '/usr/local/Cellar/cairo/1.10.2/lib:/usr/local/Cellar/cairo/1.10.2/include/cairo'
ENV['CAIRO_CFLAGS'] = '-I/usr/local/Cellar/cairo/1.10.2/include/cairo'
ENV['SHOES_DEPS_PATH'] = '/usr/local'</pre>

<p>end</p>

<p>case RUBY_PLATFORM when /mingw/</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">'rakefile_mingw'</span>)
<span class="ruby-constant">Builder</span> = <span class="ruby-constant">MakeMinGW</span>
<span class="ruby-constant">NAMESPACE</span> = :<span class="ruby-identifier">win32</span>
</pre>

<p>when /darwin/</p>

<pre class="ruby"><span class="ruby-identifier">osx_bootstrap_env</span>
<span class="ruby-identifier">require</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">'make/darwin/env'</span>)
<span class="ruby-identifier">require_relative</span> <span class="ruby-string">&quot;make/darwin/homebrew&quot;</span>
<span class="ruby-identifier">import</span> <span class="ruby-string">&quot;tasks/req.rake&quot;</span>

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">stub</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">ENV</span>[<span class="ruby-string">'MACOSX_DEPLOYMENT_TARGET'</span>] = <span class="ruby-string">'10.4'</span>
  <span class="ruby-identifier">sh</span> <span class="ruby-string">&quot;gcc -O -isysroot /Developer/SDKs/MacOSX10.4u.sdk -arch i386 -arch ppc -framework Cocoa -o stub platform/mac/stub.m -I.&quot;</span>
<span class="ruby-keyword">end</span>
<span class="ruby-constant">NAMESPACE</span> = :<span class="ruby-identifier">osx</span>
</pre>

<p>when /linux/</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">'rakefile_linux'</span>)
<span class="ruby-constant">Builder</span> = <span class="ruby-constant">MakeLinux</span>
<span class="ruby-constant">NAMESPACE</span> = :<span class="ruby-identifier">linux</span>
</pre>

<p>else</p>

<pre>puts &quot;Sorry, your platform [#{RUBY_PLATFORM}] is not supported...&quot;</pre>

<p>end</p>

<p># ————————– # common platform tasks</p>

<p>desc “Same as `rake build’” task :default =&gt; [:build]</p>

<p>desc “Does a full compile, with installer” task :package =&gt; [:build,
:installer]</p>

<p>task :build_os =&gt; [:build_skel, “dist/#{NAME}”]</p>

<p>task “shoes/version.h” do |t|</p>

<pre class="ruby"><span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>, <span class="ruby-string">'w'</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">f</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">%Q{#define SHOES_RELEASE_ID #{RELEASE_ID}\n#define SHOES_RELEASE_NAME &quot;#{RELEASE_NAME}&quot;\n#define SHOES_REVISION #{REVISION}\n#define SHOES_BUILD_DATE #{Time.now.strftime(&quot;%Y%m%d&quot;)}\n#define SHOES_PLATFORM &quot;#{SHOES_RUBY_ARCH}&quot;\n}</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>

<p>task “dist/VERSION.txt” do |t|</p>

<pre class="ruby"><span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>, <span class="ruby-string">'w'</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
              <span class="ruby-identifier">f</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">%Q{shoes #{RELEASE_ID} \&quot;#{RELEASE_NAME}\&quot; [#{RUBY_PLATFORM} Ruby-#{RUBY_VERSION}]}</span>
  <span class="ruby-node">%w[VIDEO DEBUG]</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; +#{x.downcase}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-identifier">x</span>] }
  <span class="ruby-identifier">f</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>

<p># shoes is small, if any include changes, go ahead and build from scratch.
SRC.zip(OBJ).each do |c, o|</p>

<pre class="ruby"><span class="ruby-identifier">file</span> <span class="ruby-identifier">o</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">c</span>] <span class="ruby-operator">+</span> <span class="ruby-constant">Dir</span>[<span class="ruby-string">&quot;shoes/*.h&quot;</span>]
</pre>

<p>end</p>

<p># —— # skel</p>

<p>def skel_replace(line)</p>

<pre>line.gsub! /\s+%DEFAULTS%/ do
  if APPARGS
    args = APPARGS.split(/\s+/)
    %{
      char *default_argv[] = {argv[0], #{args.inspect[1..-2]}};
      argv = default_argv;
      argc = #{args.length + 1};
    }
  end
end
line</pre>

<p>end</p>

<p># preprocess .skel task :build_skel do |t|</p>

<pre class="ruby"><span class="ruby-constant">Dir</span>[<span class="ruby-string">&quot;bin/*.skel&quot;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">src</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">name</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/\.skel$/</span>, <span class="ruby-string">'.c'</span>)
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">src</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">skel</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">name</span>, <span class="ruby-string">'w'</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">skel</span>.<span class="ruby-identifier">each_line</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">c</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">skel_replace</span>(<span class="ruby-identifier">line</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>

<p># ————————– # tasks depending on Builder = MakeLinux|MakeDarwin|<a
href="../classes/MakeMinGW.html">MakeMinGW</a></p>

<p>desc “Does a full compile, for the OS you’re running on” task :build =&gt;
[“#{NAMESPACE}:build”]</p>

<p># first refactor ; build calls platform namespaced build; # for now, each
of those calls the old build method. task :old_build =&gt; [:build_os,
“dist/VERSION.txt”] do</p>

<pre>Builder.common_build
Builder.copy_deps_to_dist
Builder.copy_files_to_dist
Builder.setup_system_resources</pre>

<p>end</p>

<p>directory ‘dist’</p>

<p>task “dist/#{NAME}” =&gt; [“dist/lib#{SONAME}.#{DLEXT}”, “bin/main.o”] +
ADD_DLL + [“#{NAMESPACE}:make_app”]</p>

<p>task “dist/lib#{SONAME}.#{DLEXT}” =&gt; [‘shoes/version.h’, ‘dist’] + OBJ +
[“#{NAMESPACE}:make_so”]</p>

<p>def cc(t)</p>

<pre>sh &quot;#{CC} -I. -c -o #{t.name} #{LINUX_CFLAGS} #{t.source}&quot;</pre>

<p>end</p>

<p>rule “.o” =&gt; “.m” do |t|</p>

<pre>cc t</pre>

<p>end</p>

<p>rule “.o” =&gt; “.c” do |t|</p>

<pre>cc t</pre>

<p>end</p>

<p>desc “Generate an installer for the current platform” task :installer =&gt;
[“#{NAMESPACE}:installer”]</p>

<p>def rewrite before, after, reg = /#{(w+)}/, reg2 = ‘1’</p>

<pre class="ruby"><span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">after</span>, <span class="ruby-string">'w'</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">before</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">b</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">a</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">line</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-identifier">reg</span>) <span class="ruby-keyword">do</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">reg2</span>.<span class="ruby-identifier">include?</span> <span class="ruby-string">'\1'</span>
          <span class="ruby-identifier">reg2</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">%r\1!</span>, <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-node">$1</span>))
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">reg2</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>

<p>def copy_files glob, dir</p>

<pre class="ruby"><span class="ruby-constant">FileList</span>[<span class="ruby-identifier">glob</span>].<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">cp_r</span> <span class="ruby-identifier">f</span>, <span class="ruby-identifier">dir</span> }
</pre>

<p>end</p>

<p>namespace :osx do</p>

<pre class="ruby"><span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">deps</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">install</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;homebrew:install&quot;</span>
  <span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">homebrew</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">desc</span> <span class="ruby-string">&quot;Install OS X dependencies using Homebrew&quot;</span>
    <span class="ruby-identifier">task</span> :<span class="ruby-identifier">install</span> =<span class="ruby-operator">&gt;</span> [:<span class="ruby-identifier">customize</span>, :<span class="ruby-identifier">install_libs</span>, :<span class="ruby-identifier">uncustomize</span>]

    <span class="ruby-identifier">task</span> :<span class="ruby-identifier">install_libs</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">brew</span> = <span class="ruby-constant">Homebrew</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-identifier">brew</span>.<span class="ruby-identifier">universal</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">'SHOES_OSX_ARCH'</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;universal&quot;</span>
      <span class="ruby-identifier">brew</span>.<span class="ruby-identifier">install_packages</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">task</span> :<span class="ruby-identifier">customize</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">brew</span> = <span class="ruby-constant">Homebrew</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-identifier">brew</span>.<span class="ruby-identifier">universal</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">'SHOES_OSX_ARCH'</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;universal&quot;</span>
      <span class="ruby-identifier">brew</span>.<span class="ruby-identifier">add_custom_remote</span>
      <span class="ruby-identifier">brew</span>.<span class="ruby-identifier">add_custom_formulas</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">task</span> :<span class="ruby-identifier">uncustomize</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">brew</span> = <span class="ruby-constant">Homebrew</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-identifier">brew</span>.<span class="ruby-identifier">universal</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">'SHOES_OSX_ARCH'</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;universal&quot;</span>
      <span class="ruby-identifier">brew</span>.<span class="ruby-identifier">remove_custom_formulas</span>
      <span class="ruby-identifier">brew</span>.<span class="ruby-identifier">remove_custom_remote</span>
    <span class="ruby-keyword">end</span>
 <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">build</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-string">&quot;build_tasks:pre_build&quot;</span>, :<span class="ruby-identifier">build_skel</span>, <span class="ruby-node">&quot;dist/#{NAME}&quot;</span>, <span class="ruby-string">&quot;dist/VERSION.txt&quot;</span>, <span class="ruby-string">&quot;build_tasks:build&quot;</span>]

<span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">build_tasks</span> <span class="ruby-keyword">do</span>

  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">build</span> =<span class="ruby-operator">&gt;</span> [:<span class="ruby-identifier">common_build</span>, :<span class="ruby-identifier">copy_deps_to_dist</span>, :<span class="ruby-identifier">change_install_names</span>, :<span class="ruby-identifier">copy_files_to_dist</span>, :<span class="ruby-identifier">setup_system_resources</span>, :<span class="ruby-identifier">verify</span>]

  <span class="ruby-comment"># Make sure the installed ruby is capable of this build</span>
  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">check_ruby_arch</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">build_arch</span>, <span class="ruby-identifier">ruby_arch</span> = [<span class="ruby-constant">OSX_ARCH</span>, <span class="ruby-constant">RbConfig</span><span class="ruby-operator">::</span><span class="ruby-constant">CONFIG</span>[<span class="ruby-string">'ARCH_FLAG'</span>]].<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">split</span>.<span class="ruby-identifier">reject</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span> <span class="ruby-identifier">w</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;arch&quot;</span>)}}
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">build_arch</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">build_arch</span>.<span class="ruby-identifier">sort</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">ruby_arch</span>.<span class="ruby-identifier">sort</span>
      <span class="ruby-identifier">abort</span>(<span class="ruby-string">&quot;To build universal shoes, you must first install a universal ruby&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">pre_build</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">check_ruby_arch</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">dylibs_to_change</span> <span class="ruby-identifier">lib</span>
    <span class="ruby-node">%xotool -L #{lib}`</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;\n&quot;</span>).<span class="ruby-identifier">inject</span>([]) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dylibs</span>, <span class="ruby-identifier">line</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span>  <span class="ruby-identifier">line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^\S/</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/System|@executable_path|libobjc/</span>
        <span class="ruby-identifier">dylibs</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">dylibs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">line</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/\s\(compatibility.*$/</span>, <span class="ruby-string">''</span>).<span class="ruby-identifier">strip</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Find additional dylibs needed by other_lib (ignoring duplicates)</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">additional_dylibs</span> <span class="ruby-identifier">dylibs</span>, <span class="ruby-identifier">other_lib</span>
    <span class="ruby-identifier">dylibs_to_change</span>(<span class="ruby-identifier">other_lib</span>).<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">basenames</span> = <span class="ruby-identifier">dylibs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">lib</span><span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">lib</span>) }
      <span class="ruby-identifier">basenames</span>.<span class="ruby-identifier">include?</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">d</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">change_install_names</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">cd</span> <span class="ruby-string">&quot;dist&quot;</span> <span class="ruby-keyword">do</span>
      [<span class="ruby-node">&quot;#{NAME}-bin&quot;</span>, <span class="ruby-string">&quot;pango-querymodules&quot;</span>, *<span class="ruby-constant">Dir</span>[<span class="ruby-string">'*.dylib'</span>], *<span class="ruby-constant">Dir</span>[<span class="ruby-string">'pango/modules/*.so'</span>]].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;install_name_tool -id @executable_path/#{File.basename f} #{f}&quot;</span>
        <span class="ruby-identifier">dylibs</span> = <span class="ruby-identifier">dylibs_to_change</span>(<span class="ruby-identifier">f</span>)
        <span class="ruby-identifier">dylibs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dylib</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;install_name_tool -change #{dylib} @executable_path/#{File.basename dylib} #{f}&quot;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">copy_pango_modules_to_dist</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">modules_file</span> = <span class="ruby-value">%xbrew --prefix`</span>.<span class="ruby-identifier">chomp</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">'/etc/pango/pango.modules'</span>
    <span class="ruby-identifier">modules_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">modules_file</span>) {<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-node">/^# ModulesPath = (.*)$/</span>){<span class="ruby-node">$1</span>}.<span class="ruby-identifier">first</span>}
    <span class="ruby-identifier">mkdir_p</span> <span class="ruby-string">'dist/pango'</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-string">'dist/pango/modules'</span>)
      <span class="ruby-identifier">cp_r</span> <span class="ruby-identifier">modules_path</span>, <span class="ruby-string">'dist/pango'</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-string">&quot;dist/pango-querymodules&quot;</span>)
      <span class="ruby-identifier">cp</span> <span class="ruby-value">%xwhich pango-querymodules`</span>.<span class="ruby-identifier">chomp</span>, <span class="ruby-string">'dist/'</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">copy_deps_to_dist</span> =<span class="ruby-operator">&gt;</span> :<span class="ruby-identifier">copy_pango_modules_to_dist</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># Generate a list of dependencies straight from the generated files.</span>
    <span class="ruby-comment"># Start with dependencies of shoes-bin and pango-querymodules, and then</span>
    <span class="ruby-comment"># add the dependencies of those dependencies.</span>
    <span class="ruby-identifier">dylibs</span> = <span class="ruby-identifier">dylibs_to_change</span>(<span class="ruby-node">&quot;dist/#{NAME}-bin&quot;</span>)
    <span class="ruby-identifier">dylibs</span>.<span class="ruby-identifier">dup</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dylib</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">dylibs</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">additional_dylibs</span>(<span class="ruby-identifier">dylibs</span>, <span class="ruby-identifier">dylib</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">dylibs</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">libn</span><span class="ruby-operator">|</span> <span class="ruby-identifier">cp</span> <span class="ruby-node">&quot;#{libn}&quot;</span>, <span class="ruby-string">&quot;dist/&quot;</span>}
    <span class="ruby-comment"># Verbose mode raises an exception (ruby bug?)</span>
    <span class="ruby-identifier">chmod_R</span> <span class="ruby-string">&quot;u+w&quot;</span>, <span class="ruby-string">&quot;dist/&quot;</span>, :<span class="ruby-identifier">verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">copy_files_to_dist</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">'APP'</span>]
      <span class="ruby-keyword">if</span> <span class="ruby-constant">APP</span>[<span class="ruby-string">'clone'</span>]
        <span class="ruby-identifier">sh</span> <span class="ruby-constant">APP</span>[<span class="ruby-string">'clone'</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^git /</span>, <span class="ruby-node">&quot;#{GIT} --git-dir=#{ENV['APP']}/.git &quot;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">cp_r</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">'APP'</span>], <span class="ruby-string">&quot;dist/app&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-constant">APP</span>[<span class="ruby-string">'ignore'</span>]
        <span class="ruby-constant">APP</span>[<span class="ruby-string">'ignore'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">nn</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">rm_rf</span> <span class="ruby-node">&quot;dist/app/#{nn}&quot;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">cp_r</span>  <span class="ruby-string">&quot;fonts&quot;</span>, <span class="ruby-string">&quot;dist/fonts&quot;</span>
    <span class="ruby-identifier">cp_r</span>  <span class="ruby-string">&quot;lib&quot;</span>, <span class="ruby-string">&quot;dist/lib&quot;</span>
    <span class="ruby-identifier">cp_r</span>  <span class="ruby-string">&quot;samples&quot;</span>, <span class="ruby-string">&quot;dist/samples&quot;</span>
    <span class="ruby-identifier">cp_r</span>  <span class="ruby-string">&quot;static&quot;</span>, <span class="ruby-string">&quot;dist/static&quot;</span>
    <span class="ruby-identifier">cp</span>    <span class="ruby-string">&quot;README.md&quot;</span>, <span class="ruby-string">&quot;dist/README.txt&quot;</span>
    <span class="ruby-identifier">cp</span>    <span class="ruby-string">&quot;CHANGELOG&quot;</span>, <span class="ruby-string">&quot;dist/CHANGELOG.txt&quot;</span>
    <span class="ruby-identifier">cp</span>    <span class="ruby-string">&quot;COPYING&quot;</span>, <span class="ruby-string">&quot;dist/COPYING.txt&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">setup_system_resources</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">rm_rf</span> <span class="ruby-node">&quot;#{APPNAME}.app&quot;</span>
    <span class="ruby-identifier">mkdir</span> <span class="ruby-node">&quot;#{APPNAME}.app&quot;</span>
    <span class="ruby-identifier">mkdir</span> <span class="ruby-node">&quot;#{APPNAME}.app/Contents&quot;</span>
    <span class="ruby-identifier">cp_r</span> <span class="ruby-string">&quot;dist&quot;</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS&quot;</span>
    <span class="ruby-identifier">mkdir</span> <span class="ruby-node">&quot;#{APPNAME}.app/Contents/Resources&quot;</span>
    <span class="ruby-identifier">mkdir</span> <span class="ruby-node">&quot;#{APPNAME}.app/Contents/Resources/English.lproj&quot;</span>
    <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;ditto \&quot;#{APP['icons']['osx']}\&quot; \&quot;#{APPNAME}.app/App.icns\&quot;&quot;</span>
    <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;ditto \&quot;#{APP['icons']['osx']}\&quot; \&quot;#{APPNAME}.app/Contents/Resources/App.icns\&quot;&quot;</span>
    <span class="ruby-identifier">rewrite</span> <span class="ruby-string">&quot;platform/mac/Info.plist&quot;</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/Info.plist&quot;</span>
    <span class="ruby-identifier">cp</span> <span class="ruby-string">&quot;platform/mac/version.plist&quot;</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/&quot;</span>
    <span class="ruby-identifier">rewrite</span> <span class="ruby-string">&quot;platform/mac/pangorc&quot;</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS/pangorc&quot;</span>
    <span class="ruby-identifier">cp</span> <span class="ruby-string">&quot;platform/mac/command-manual.rb&quot;</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS/&quot;</span>
    <span class="ruby-identifier">rewrite</span> <span class="ruby-string">&quot;platform/mac/shoes-launch&quot;</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS/#{NAME}-launch&quot;</span>
    <span class="ruby-identifier">chmod</span> <span class="ruby-value">0755</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS/#{NAME}-launch&quot;</span>
    <span class="ruby-identifier">chmod</span> <span class="ruby-value">0755</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS/#{NAME}-bin&quot;</span>
    <span class="ruby-identifier">rewrite</span> <span class="ruby-string">&quot;platform/mac/shoes&quot;</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS/#{NAME}&quot;</span>
    <span class="ruby-identifier">chmod</span> <span class="ruby-value">0755</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS/#{NAME}&quot;</span>
    <span class="ruby-identifier">chmod_R</span> <span class="ruby-value">0755</span>, <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS/pango-querymodules&quot;</span>
    <span class="ruby-comment"># cp InfoPlist.strings YourApp.app/Contents/Resources/English.lproj/</span>
    <span class="ruby-node">%xecho -n 'APPL????' &gt; &quot;#{APPNAME}.app/Contents/PkgInfo&quot;`</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">desc</span> <span class="ruby-string">&quot;Verify the build products&quot;</span>
<span class="ruby-identifier">task</span> :<span class="ruby-identifier">verify</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-string">'verify:sanity'</span>, <span class="ruby-string">'verify:lib_paths'</span>]

<span class="ruby-identifier">namespace</span> :<span class="ruby-identifier">verify</span> <span class="ruby-keyword">do</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">report_error</span> <span class="ruby-identifier">message</span>
    <span class="ruby-constant">STDERR</span>.<span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;BUILD ERROR: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">message</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">sanity</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">report_error</span> <span class="ruby-node">&quot;No #{APPNAME}.app file found&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-node">&quot;#{APPNAME}.app&quot;</span>
    [<span class="ruby-constant">NAME</span>, <span class="ruby-node">&quot;#{NAME}-launch&quot;</span>, <span class="ruby-node">&quot;#{NAME}-bin&quot;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">report_error</span> <span class="ruby-node">&quot;No #{f} file found&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS/#{f}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">task</span> :<span class="ruby-identifier">lib_paths</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">cd</span> <span class="ruby-node">&quot;#{APPNAME}.app/Contents/MacOS&quot;</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">errors</span> = []
      [<span class="ruby-node">&quot;#{NAME}-bin&quot;</span>, <span class="ruby-string">&quot;pango-querymodules&quot;</span>, *<span class="ruby-constant">Dir</span>[<span class="ruby-string">'*.dylib'</span>], *<span class="ruby-constant">Dir</span>[<span class="ruby-string">'pango/modules/*.so'</span>]].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">dylibs</span> = <span class="ruby-identifier">dylibs_to_change</span>(<span class="ruby-identifier">f</span>)
        <span class="ruby-identifier">dylibs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dylib</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Suspect library path on #{f}:\n  #{dylib}\n  (check with `otool -L #{File.expand_path f}`)&quot;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span> <span class="ruby-identifier">report_error</span> <span class="ruby-identifier">e</span>}
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">make_app</span> <span class="ruby-keyword">do</span>
  <span class="ruby-comment"># Builder.make_app &quot;dist/#{NAME}&quot;</span>
  <span class="ruby-identifier">bin</span> = <span class="ruby-node">&quot;dist/#{NAME}-bin&quot;</span>
  <span class="ruby-identifier">rm_f</span> <span class="ruby-node">&quot;dist/#{NAME}&quot;</span>
  <span class="ruby-identifier">rm_f</span> <span class="ruby-identifier">bin</span>
  <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;#{CC} -Ldist -o #{bin} bin/main.o #{LINUX_LIBS} -lshoes #{OSX_ARCH}&quot;</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">make_so</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;dist/lib#{SONAME}.#{DLEXT}&quot;</span>
  <span class="ruby-identifier">ldflags</span> = <span class="ruby-constant">LINUX_LDFLAGS</span>.<span class="ruby-identifier">sub!</span> <span class="ruby-regexp">/INSTALL_NAME/</span>, <span class="ruby-node">&quot;-install_name @executable_path/lib#{SONAME}.#{DLEXT}&quot;</span>
    <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;#{CC} -o #{name} #{OBJ.join(' ')} #{LINUX_LDFLAGS} #{LINUX_LIBS}&quot;</span>
    <span class="ruby-node">%w[libpostproc.dylib libavformat.dylib libavcodec.dylib libavutil.dylib libruby.dylib]</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">libn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;install_name_tool -change /tmp/dep/lib/#{libn} ./deps/lib/#{libn} #{name}&quot;</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">installer</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">dmg_ds</span>, <span class="ruby-identifier">dmg_jpg</span> = <span class="ruby-string">&quot;platform/mac/dmg_ds_store&quot;</span>, <span class="ruby-string">&quot;static/shoes-dmg.jpg&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-constant">APP</span>[<span class="ruby-string">'dmg'</span>]
    <span class="ruby-identifier">dmg_ds</span>, <span class="ruby-identifier">dmg_jpg</span> = <span class="ruby-constant">APP</span>[<span class="ruby-string">'dmg'</span>][<span class="ruby-string">'ds_store'</span>], <span class="ruby-constant">APP</span>[<span class="ruby-string">'dmg'</span>][<span class="ruby-string">'background'</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">mkdir_p</span> <span class="ruby-string">&quot;pkg&quot;</span>
  <span class="ruby-identifier">rm_rf</span> <span class="ruby-string">&quot;dmg&quot;</span>
  <span class="ruby-identifier">mkdir_p</span> <span class="ruby-string">&quot;dmg&quot;</span>
  <span class="ruby-identifier">cp_r</span> <span class="ruby-node">&quot;#{APPNAME}.app&quot;</span>, <span class="ruby-string">&quot;dmg&quot;</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">'APP'</span>]
    <span class="ruby-identifier">mv</span> <span class="ruby-node">&quot;dmg/#{APPNAME}.app/Contents/MacOS/samples&quot;</span>, <span class="ruby-string">&quot;dmg/samples&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">ln_s</span> <span class="ruby-string">&quot;/Applications&quot;</span>, <span class="ruby-string">&quot;dmg/Applications&quot;</span>
  <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;chmod +x dmg/\&quot;#{APPNAME}.app\&quot;/Contents/MacOS/pango-querymodules&quot;</span>
  <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;chmod +x dmg/\&quot;#{APPNAME}.app\&quot;/Contents/MacOS/#{NAME}&quot;</span>
  <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;chmod +x dmg/\&quot;#{APPNAME}.app\&quot;/Contents/MacOS/#{NAME}-bin&quot;</span>
  <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;chmod +x dmg/\&quot;#{APPNAME}.app\&quot;/Contents/MacOS/#{NAME}-launch&quot;</span>
  <span class="ruby-identifier">sh</span> <span class="ruby-node">&quot;DYLD_LIBRARY_PATH= platform/mac/pkg-dmg --target pkg/#{PKG}.dmg --source dmg --volname '#{APPNAME}' --copy #{dmg_ds}:/.DS_Store --mkdir /.background --copy #{dmg_jpg}:/.background&quot;</span> <span class="ruby-comment"># --format UDRW&quot;</span>
  <span class="ruby-identifier">rm_rf</span> <span class="ruby-string">&quot;dmg&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>

<p>namespace :win32 do</p>

<pre class="ruby"><span class="ruby-identifier">task</span> :<span class="ruby-identifier">build</span> =<span class="ruby-operator">&gt;</span> [:<span class="ruby-identifier">old_build</span>]

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">make_app</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">Builder</span>.<span class="ruby-identifier">make_app</span> <span class="ruby-node">&quot;dist/#{NAME}&quot;</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">make_so</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">Builder</span>.<span class="ruby-identifier">make_so</span>  <span class="ruby-node">&quot;dist/lib#{SONAME}.#{DLEXT}&quot;</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">installer</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">Builder</span>.<span class="ruby-identifier">make_installer</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>

<p>namespace :linux do</p>

<pre class="ruby"><span class="ruby-identifier">task</span> :<span class="ruby-identifier">build</span> =<span class="ruby-operator">&gt;</span> [:<span class="ruby-identifier">old_build</span>]

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">make_app</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">Builder</span>.<span class="ruby-identifier">make_app</span> <span class="ruby-node">&quot;dist/#{NAME}&quot;</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">make_so</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">Builder</span>.<span class="ruby-identifier">make_so</span>  <span class="ruby-node">&quot;dist/lib#{SONAME}.#{DLEXT}&quot;</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">task</span> :<span class="ruby-identifier">installer</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">Builder</span>.<span class="ruby-identifier">make_installer</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>

    </div>
  


  


  
  


  


  

  



  

    

    

    


    


    <!-- Methods -->
              </div>

    </div>
  </body>
</html>